========== [2025-06-29 21:21:37] getDiscussionsForUser Attempt ==========
User ID: 1, Role: admin
Final SQL Query:

            SELECT 
                d.id, d.reason, d.notes, d.status, d.created_at,
                d.discussable_type, d.discussable_id,
                opener.id as opener_id,
                opener.username as opener_name,
                
                -- Context-specific fields, populated based on the type of discussion
                COALESCE(t_from_review.ticket_number, t_direct.ticket_number) as ticket_number,
                COALESCE(td.ticket_id, t_direct.id) as ticket_id,
                dr.name as driver_name,
                dc.driver_id as driver_id,
                creator.username as created_by_name -- The agent whose work is being discussed

            FROM discussions d
            JOIN users opener ON d.opened_by = opener.id
            
            -- Join to find the related review, if any
            LEFT JOIN reviews r ON d.discussable_type = 'App\\Models\\Review\\Review' AND d.discussable_id = r.id
            
            -- Join for Ticket-related context
            LEFT JOIN ticket_details td ON r.reviewable_type IN ('ticket_detail', 'App\\Models\\Tickets\\TicketDetail') AND r.reviewable_id = td.id
            LEFT JOIN tickets t_from_review ON td.ticket_id = t_from_review.id
            
            -- Join for Call-related context
            LEFT JOIN driver_calls dc ON r.reviewable_type IN ('driver_call', 'App\\Models\\Call\\DriverCall') AND r.reviewable_id = dc.id
            LEFT JOIN drivers dr ON dc.driver_id = dr.id

            -- Join for direct Ticket discussions
            LEFT JOIN tickets t_direct ON d.discussable_type = 'App\\Models\\Tickets\\Ticket' AND d.discussable_id = t_direct.id

            -- Join to find the agent who did the work (the creator of the reviewed item)
            LEFT JOIN users creator ON creator.id = (
                CASE
                    WHEN td.edited_by IS NOT NULL THEN td.edited_by
                    WHEN dc.call_by IS NOT NULL THEN dc.call_by
                    WHEN t_direct.created_by IS NOT NULL THEN t_direct.created_by
                    ELSE NULL
                END
            )
         ORDER BY d.status ASC, d.created_at DESC
Parameters: []
Query executed successfully. Number of discussions found: 16
========== End of Attempt ==========

========== [2025-06-29 21:24:18] getDiscussionsForUser Attempt ==========
User ID: 1, Role: admin
Final SQL Query:

            SELECT 
                d.id, d.reason, d.notes, d.status, d.created_at,
                d.discussable_type, d.discussable_id,
                opener.id as opener_id,
                opener.username as opener_name,
                
                -- Context-specific fields, populated based on the type of discussion
                COALESCE(t_from_review.ticket_number, t_direct.ticket_number) as ticket_number,
                COALESCE(td.ticket_id, t_direct.id) as ticket_id,
                dr.name as driver_name,
                dc.driver_id as driver_id,
                creator.username as created_by_name -- The agent whose work is being discussed

            FROM discussions d
            JOIN users opener ON d.opened_by = opener.id
            
            -- Join to find the related review, if any
            LEFT JOIN reviews r ON d.discussable_type = 'App\\Models\\Review\\Review' AND d.discussable_id = r.id
            
            -- Join for Ticket-related context
            LEFT JOIN ticket_details td ON r.reviewable_type IN ('ticket_detail', 'App\\Models\\Tickets\\TicketDetail') AND r.reviewable_id = td.id
            LEFT JOIN tickets t_from_review ON td.ticket_id = t_from_review.id
            
            -- Join for Call-related context
            LEFT JOIN driver_calls dc ON r.reviewable_type IN ('driver_call', 'App\\Models\\Call\\DriverCall') AND r.reviewable_id = dc.id
            LEFT JOIN drivers dr ON dc.driver_id = dr.id

            -- Join for direct Ticket discussions
            LEFT JOIN tickets t_direct ON d.discussable_type = 'App\\Models\\Tickets\\Ticket' AND d.discussable_id = t_direct.id

            -- Join to find the agent who did the work (the creator of the reviewed item)
            LEFT JOIN users creator ON creator.id = (
                CASE
                    WHEN td.edited_by IS NOT NULL THEN td.edited_by
                    WHEN dc.call_by IS NOT NULL THEN dc.call_by
                    WHEN t_direct.created_by IS NOT NULL THEN t_direct.created_by
                    ELSE NULL
                END
            )
         ORDER BY d.status ASC, d.created_at DESC
Parameters: []
Query executed successfully. Number of discussions found: 16
========== End of Attempt ==========

========== [2025-06-29 21:24:28] getDiscussionsForUser Attempt ==========
User ID: 1, Role: admin
Final SQL Query:

            SELECT 
                d.id, d.reason, d.notes, d.status, d.created_at,
                d.discussable_type, d.discussable_id,
                opener.id as opener_id,
                opener.username as opener_name,
                
                -- Context-specific fields, populated based on the type of discussion
                COALESCE(t_from_review.ticket_number, t_direct.ticket_number) as ticket_number,
                COALESCE(td.ticket_id, t_direct.id) as ticket_id,
                dr.name as driver_name,
                dc.driver_id as driver_id,
                creator.username as created_by_name -- The agent whose work is being discussed

            FROM discussions d
            JOIN users opener ON d.opened_by = opener.id
            
            -- Join to find the related review, if any
            LEFT JOIN reviews r ON d.discussable_type = 'App\\Models\\Review\\Review' AND d.discussable_id = r.id
            
            -- Join for Ticket-related context
            LEFT JOIN ticket_details td ON r.reviewable_type IN ('ticket_detail', 'App\\Models\\Tickets\\TicketDetail') AND r.reviewable_id = td.id
            LEFT JOIN tickets t_from_review ON td.ticket_id = t_from_review.id
            
            -- Join for Call-related context
            LEFT JOIN driver_calls dc ON r.reviewable_type IN ('driver_call', 'App\\Models\\Call\\DriverCall') AND r.reviewable_id = dc.id
            LEFT JOIN drivers dr ON dc.driver_id = dr.id

            -- Join for direct Ticket discussions
            LEFT JOIN tickets t_direct ON d.discussable_type = 'App\\Models\\Tickets\\Ticket' AND d.discussable_id = t_direct.id

            -- Join to find the agent who did the work (the creator of the reviewed item)
            LEFT JOIN users creator ON creator.id = (
                CASE
                    WHEN td.edited_by IS NOT NULL THEN td.edited_by
                    WHEN dc.call_by IS NOT NULL THEN dc.call_by
                    WHEN t_direct.created_by IS NOT NULL THEN t_direct.created_by
                    ELSE NULL
                END
            )
         ORDER BY d.status ASC, d.created_at DESC
Parameters: []
Query executed successfully. Number of discussions found: 16
========== End of Attempt ==========

